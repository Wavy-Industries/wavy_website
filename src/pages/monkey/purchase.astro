---
import '~/styles/global.css';
import Layout from "~/layouts/Layout.astro";
import StockSubscribe from '~/components/StockSubscribe.astro';

import logoImg from '~/assets/logo.svg';
import { routes } from '~/routes';
---

<Layout title="Wavy Industries: Monkey purchase">
  <section>
    <div class="banner"><img src={logoImg.src} /></div>
    <div>
      <div class="content">
        <h4>WAVY MONKEY</h4>
        <p>
          Price: <b id="product-price">Loading price…</b> <span id="VAT">ex. VAT</span><br/>
          <i class="shipping-info">Depending on your country, import taxes may apply. We collect duties for you in the EU and UK, so you will not have to pay additionally upon delivery.</i>
        </p>
        <p>MONKEY ships within a few days of your order, but delays may occur if it is out of stock.</p>
          <!-- <div id="shipping-status"></div>
          <div id="shipping-status-leadtime" class="shipping-info"></div> -->
      </div>
      <hr />
    </div>
     <!-- <hr /> -->
     <center>

<div id="buy-now-wrapper">
  <button id="buy-now-button" class="chechout-button" disabled>Loading…</button>
  <p id="buy-error" class="shipping-info hidden"></p>
</div>

<script type="text/javascript">
(function () {
  var scriptURL = 'https://sdks.shopifycdn.com/buy-button/latest/buy-button-storefront.min.js';
  // Shopify Storefront API expects global IDs (gid://shopify/Product/<id>)
  var productId = 'gid://shopify/Product/14798616985972';
  var domain = 'gz6v0f-4p.myshopify.com';
  var token = '3f43932f0e0e93973efb1da30bd44f74';
  var storefrontApi = 'https://' + domain + '/api/2024-01/graphql.json';

  var buyButton = document.getElementById('buy-now-button');
  var errorEl = document.getElementById('buy-error');
  var priceEl = document.getElementById('product-price');
  var client;
  var variantId;

  function setButtonState(disabled, text) {
    if (!buyButton) return;
    buyButton.disabled = !!disabled;
    buyButton.textContent = text;
  }

  function showError(message) {
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
    }
    setButtonState(true, 'Unavailable');
  }

  function guessCountryCode() {
    var locale = (navigator.languages && navigator.languages[0]) || navigator.language || '';
    var parts = locale.split('-');
    if (parts.length > 1 && parts[1]) {
      return parts[1].toUpperCase();
    }
    return null;
  }

  function fetchProductData() {
    var countryCode = guessCountryCode();
    var query = countryCode
      ? "query productPrice($id: ID!, $country: CountryCode) @inContext(country: $country) { product(id: $id) { variants(first: 1) { edges { node { id price { amount currencyCode } priceV2 { amount currencyCode } } } } } }"
      : "query productPrice($id: ID!) { product(id: $id) { variants(first: 1) { edges { node { id price { amount currencyCode } priceV2 { amount currencyCode } } } } } }";

    var variables = countryCode ? { id: productId, country: countryCode } : { id: productId };

    return fetch(storefrontApi, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Shopify-Storefront-Access-Token': token,
      },
      body: JSON.stringify({ query: query, variables: variables }),
    }).then(function (res) { return res.json(); }).then(function (resp) {
      if (!resp || !resp.data || !resp.data.product || !resp.data.product.variants.edges.length) {
        throw new Error('No product data returned');
      }
      var variant = resp.data.product.variants.edges[0].node;
      variantId = variant.id;
      var priceObj = variant.priceV2 || variant.price;
      if (priceObj && priceObj.amount && priceObj.currencyCode && priceEl) {
        var formatter = new Intl.NumberFormat(undefined, { style: 'currency', currency: priceObj.currencyCode });
        priceEl.textContent = formatter.format(priceObj.amount);
      }
      setButtonState(false, 'Buy now');
    });
  }

  function loadScript() {
    var script = document.createElement('script');
    script.async = true;
    script.src = scriptURL;
    script.onload = initShopify;
    (document.head || document.body).appendChild(script);
  }

  function initShopify() {
    if (!window.ShopifyBuy || !window.ShopifyBuy.buildClient) {
      showError('Failed to load store client.');
      return;
    }

    client = window.ShopifyBuy.buildClient({
      domain: domain,
      storefrontAccessToken: token,
    });

    fetchProductData().catch(function (err) {
      console.error(err);
      showError('Product unavailable right now.');
    });
  }

  function handleBuy() {
    if (!client || !variantId) {
      showError('Product unavailable right now.');
      return;
    }

    setButtonState(true, 'Redirecting…');
    client.checkout.create().then(function (checkout) {
      return client.checkout.addLineItems(checkout.id, [{
        variantId: variantId,
        quantity: 1,
      }]);
    }).then(function (checkout) {
      window.location.href = checkout.webUrl;
    }).catch(function (err) {
      console.error(err);
      showError('Could not start checkout.');
    });
  }

  if (buyButton) {
    buyButton.addEventListener('click', handleBuy);
  }

  if (window.ShopifyBuy && window.ShopifyBuy.buildClient) {
    initShopify();
  } else {
    loadScript();
  }
})();
</script>
    <p class="shipping-info">By proceeding you agree to our sales <a target="_blank" href={routes.termsAndConditions}>terms & conditions.</a> </p>
    <br/>
   <div id="stock-notify-form" class="content hidden">
     <StockSubscribe />
   </div>
  </section>
</Layout>


<style>  
section {
  margin: 75px auto;
  width: 400px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}
  
hr {
  border: 0;
  margin: 0;
  height: 1px;
  background: #d5d5d5;
}

input {
  margin-top: 10px;
}

.banner {
  background-color: #d5d5d5;
  padding: 20px;
}

.content {
  background-color: #F5F5F5;
  padding: 20px;
  /* min-height: 300px; */
}

#VAT {
  font-size: 12px;
  margin-left: 5px;
  font-style: italic;
}

.chechout-button {
  background-color: #5A88FF;
  color: white;
  width: 100%;
  border: none;
  padding: 20px 0;
  font-weight: bold;
  font-size: 16px;
  text-align: center;
}

.chechout-button:hover {
  background-color: #4378ff;
  /* cursor: pointer; */
  text-decoration: none;
}

/* add stock status classes with light background colors */
#shipping-status {
  padding: 5px;
  margin-top: 10px;
  font-style: italic;
  display: inline-block;
}

.shipping-info {
  font-size: 12px;
  font-style: italic;
}

.in-stock {
  background-color: #d4edda;
}

.out-of-stock {
  background-color: #f7f8d7;
}

.low-stock {
  background-color: #f4ffcd;
}

.unknown-stock {
  background-color: #eee;
}
.hidden {
  display: none;
}
</style>

<script>
async function getStockStatus() {
  try {
    const response = await fetch('https://server.wavyindustries.com/api/product/getStock/WIMKY001');
    const data = await response.json();
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const stock_status = data.stock_status;
    let shippingStatus = document.getElementById('shipping-status');
    let shippingLeadtime = document.getElementById('shipping-status-leadtime');
    shippingStatus.innerHTML = 'Status: ' + stock_status;
    shippingLeadtime.innerHTML = '';

    // add status class based on status, using switch
    switch (stock_status) {
      case 'in stock':
        shippingStatus.classList.add('in-stock');
        break;
      case 'out of stock':
        shippingStatus.classList.add('out-of-stock');
        shippingLeadtime.innerHTML = 'Lead time: 5. November';

        const notifyForm = document.getElementById('stock-notify-form');
        if (notifyForm) {
          notifyForm.classList.remove('hidden');
        }
        break;
      case 'low stock':
        shippingStatus.classList.add('low-stock');
        break;
      default:
        shippingStatus.classList.add('unknown-stock');
    }
  } catch (error) {
    console.error('Error:', error);
  }
}
getStockStatus();
</script>
